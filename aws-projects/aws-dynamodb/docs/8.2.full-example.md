# 🔥 **Real-World Example: Modeling Users & Orders in DynamoDB**

In this example, we will:  
1️⃣ **Create a Users table** (storing user details & orders in a single table).  
2️⃣ **Use a Global Secondary Index (GSI) to retrieve orders by UserID**.  
3️⃣ **Perform read & write operations using AWS CLI & Python SDK**.

---

## 🏗 **Step 1: Creating the Table in DynamoDB**

We will store **users and orders in the same table**, using:

- **Partition Key:** `PK` (Primary Key)
- **Sort Key:** `SK` (to differentiate users and orders)
- **GSI:** `UserID` (to allow fetching orders by user)

### **Table Schema**

| **PK (Primary Key)** | **SK (Sort Key)** | **UserID (GSI)** | **Data**                                          |
| -------------------- | ----------------- | ---------------- | ------------------------------------------------- |
| `USER#USR001`        | `PROFILE`         | `USR001`         | `{ "Name": "Alice", "Email": "alice@email.com" }` |
| `USER#USR001`        | `ORDER#ORD1001`   | `USR001`         | `{ "Amount": 50, "Status": "Shipped" }`           |
| `USER#USR001`        | `ORDER#ORD1002`   | `USR001`         | `{ "Amount": 30, "Status": "Processing" }`        |
| `USER#USR002`        | `PROFILE`         | `USR002`         | `{ "Name": "Bob", "Email": "bob@email.com" }`     |
| `USER#USR002`        | `ORDER#ORD1003`   | `USR002`         | `{ "Amount": 100, "Status": "Delivered" }`        |

✅ **This allows us to retrieve all orders for a user by querying `UserID`.**

---

### 📌 **Create Table with AWS CLI**

```sh
aws dynamodb create-table \
    --table-name Users \
    --attribute-definitions \
        AttributeName=PK,AttributeType=S \
        AttributeName=SK,AttributeType=S \
        AttributeName=UserID,AttributeType=S \
    --key-schema \
        AttributeName=PK,KeyType=HASH \
        AttributeName=SK,KeyType=RANGE \
    --global-secondary-indexes \
        "[{
            \"IndexName\": \"UserID-index\",
            \"KeySchema\": [{\"AttributeName\": \"UserID\", \"KeyType\": \"HASH\"}],
            \"Projection\": {\"ProjectionType\": \"ALL\"},
            \"ProvisionedThroughput\": {\"ReadCapacityUnits\": 5, \"WriteCapacityUnits\": 5}
        }]" \
    --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5
```

✅ This command creates:

- A **Users table** with a **primary key (PK, SK)**.
- A **GSI on `UserID`** to efficiently query orders by user.

---

## 📝 **Step 2: Insert Data into DynamoDB (AWS CLI & Python)**

### **AWS CLI: Insert Users & Orders**

```sh
aws dynamodb put-item --table-name Users --item '{
    "PK": {"S": "USER#USR001"},
    "SK": {"S": "PROFILE"},
    "UserID": {"S": "USR001"},
    "Name": {"S": "Alice"},
    "Email": {"S": "alice@email.com"}
}'

aws dynamodb put-item --table-name Users --item '{
    "PK": {"S": "USER#USR001"},
    "SK": {"S": "ORDER#ORD1001"},
    "UserID": {"S": "USR001"},
    "Amount": {"N": "50"},
    "Status": {"S": "Shipped"}
}'

aws dynamodb put-item --table-name Users --item '{
    "PK": {"S": "USER#USR001"},
    "SK": {"S": "ORDER#ORD1002"},
    "UserID": {"S": "USR001"},
    "Amount": {"N": "30"},
    "Status": {"S": "Processing"}
}'
```

✅ This inserts:

- A **User Profile** (`PK="USER#USR001", SK="PROFILE"`)
- **Two Orders** (`PK="USER#USR001", SK="ORDER#ORD1001"` and `ORDER#ORD1002`)

---

### **Python: Insert Data with Boto3**

```python
import boto3

dynamodb = boto3.resource('dynamodb')
table = dynamodb.Table('Users')

# Insert User
table.put_item(Item={
    'PK': 'USER#USR001',
    'SK': 'PROFILE',
    'UserID': 'USR001',
    'Name': 'Alice',
    'Email': 'alice@email.com'
})

# Insert Orders
orders = [
    {'PK': 'USER#USR001', 'SK': 'ORDER#ORD1001', 'UserID': 'USR001', 'Amount': 50, 'Status': 'Shipped'},
    {'PK': 'USER#USR001', 'SK': 'ORDER#ORD1002', 'UserID': 'USR001', 'Amount': 30, 'Status': 'Processing'}
]

for order in orders:
    table.put_item(Item=order)
```

✅ This script does the **same as the CLI commands but using Python**.

---

## 🔎 **Step 3: Query Data (Get Orders for a User)**

### **AWS CLI: Query User Orders**

```sh
aws dynamodb query --table-name Users \
    --index-name UserID-index \
    --key-condition-expression "UserID = :userid" \
    --expression-attribute-values '{":userid": {"S": "USR001"}}'
```

✅ **This fetches all orders** where `UserID = "USR001"` using the **GSI**.

---

### **Python: Query Orders by User**

```python
response = table.query(
    IndexName='UserID-index',
    KeyConditionExpression="UserID = :userid",
    ExpressionAttributeValues={":userid": "USR001"}
)

for item in response['Items']:
    print(item)
```

✅ **This retrieves all orders for `USR001` using the GSI.**

---

## 🎯 **Final Thoughts**

✅ **We stored Users & Orders in a single table using partition & sort keys.**  
✅ **We used a GSI on `UserID` to efficiently retrieve orders per user.**  
✅ **Queries retrieve orders fast without joins!**  
✅ **This approach is scalable and cost-efficient for high-traffic apps.**

---

## 🎨 **DynamoDB Data Model Workflow (Mermaid Diagram)**

```mermaid
graph TD
    A[Users Table] -- PK: USER#USR001, SK: PROFILE --> B[User Profile: Alice]
    A -- PK: USER#USR001, SK: ORDER#ORD1001 --> C[Order ORD1001]
    A -- PK: USER#USR001, SK: ORDER#ORD1002 --> D[Order ORD1002]
    A -- Uses GSI to Query Orders --> E[Orders Table (GSI: UserID)]
```

✅ **This visualizes how we structure users & orders without using joins.**

---

## 🚀 **Next Steps**

💡 **Want to extend this example?**

- Add a **Products Table** and store `OrderID` inside each product.
- Create a **serverless API (AWS Lambda + API Gateway) to query orders**.
- Implement **DynamoDB Streams to trigger notifications when an order is updated**.

🔥 **Let me know if you want more enhancements!** 🚀
