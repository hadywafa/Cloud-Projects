# ğŸ” **DynamoDB FilterExpression**

DynamoDB's **`FilterExpression`** allows you to **filter query or scan results** based on **non-key attributes**. However, **it does not reduce the number of read capacity units (RCUs) consumed** because filtering is applied **after** data retrieval.

---

## ğŸ“Œ **How `FilterExpression` Works**

<div style="text-align: center;">
  <img src="images/ddb-read-filters.png" alt="DynamoDB FilterExpression" />
</div>

---

1ï¸âƒ£ **Query or Scan fetches all matching items based on key conditions.**  
2ï¸âƒ£ **DynamoDB loads the full dataset into memory** (this is what consumes RCUs).  
3ï¸âƒ£ **FilterExpression is applied to the retrieved dataset**.  
4ï¸âƒ£ **Only items that match the filter are returned to the client**.

ğŸ“Œ **Key takeaway:** **Filter expressions do not reduce read costs because they are applied after items are read from storage.**

---

## ğŸ”¹ **Comparison: Query vs. FilterExpression**

| **Scenario**                             | **Uses Indexes?** | **Applies Before Reading Data?** | **Reduces RCU Usage?** |
| ---------------------------------------- | ----------------- | -------------------------------- | ---------------------- |
| **Query with KeyConditionExpression** âœ… | **Yes**           | **Before** retrieving items      | âœ… **Yes**             |
| **FilterExpression on Query/Scan** âŒ    | **No**            | **After** retrieving items       | âŒ **No**              |

---

## ğŸ”¹ **How `FilterExpression` Affects RCUs?**

- **Query operations** **only consume RCUs for items that match the key condition**, but applying a `FilterExpression` on non-key attributes **does not reduce the RCUs used**.
- **Scan operations** consume **RCUs for all items scanned**, even if the filter eliminates many of them.

ğŸ“Œ **Formula for RCUs Used:**

```plaintext
Total RCUs Used = (All Retrieved Item Size / 4 KB) * Consistency Factor
```

- **Strongly Consistent Reads**: Consistency Factor = **1**
- **Eventually Consistent Reads**: Consistency Factor = **0.5**

---

## ğŸ“ **Using `FilterExpression` in Queries**

### âœ… **Example 1: Query Orders with a Filter on `TotalAmount`**

```sh
aws dynamodb query \
    --table-name Orders \
    --key-condition-expression "CustomerID = :cust" \
    --filter-expression "TotalAmount > :amount" \
    --expression-attribute-values '{
        ":cust": {"S": "User123"},
        ":amount": {"N": "100"}
    }'
```

ğŸ“Œ **Explanation:**

- Queries **all orders** for `CustomerID = "User123"`.
- **Retrieves all orders into memory** (costing RCUs).
- **Filters out orders where `TotalAmount <= 100`**.
- **Returned dataset is smaller, but RCUs are still charged for all retrieved items**.

---

### âœ… **Example 2: Query Employees with a Filter on Department**

```sh
aws dynamodb query \
    --table-name Employee \
    --key-condition-expression "ManagerID = :mgr" \
    --filter-expression "Department = :dept" \
    --expression-attribute-values '{
        ":mgr": {"S": "MGR123"},
        ":dept": {"S": "Engineering"}
    }'
```

ğŸ“Œ **Explanation:**

- Queries **all employees** who report to `MGR123`.
- **Retrieves all direct reports** into memory.
- **Filters only employees in `Engineering`**.

---

## ğŸ“ **Using `FilterExpression` in Scans**

### âœ… **Example 3: Scan Employees and Filter by Job Title**

```sh
aws dynamodb scan \
    --table-name Employee \
    --filter-expression "JobTitle = :title" \
    --expression-attribute-values '{":title": {"S": "Software Engineer"}}'
```

ğŸ“Œ **Explanation:**

- Reads **every item in the table**, consuming **RCUs for all scanned items**.
- **Filters out non-matching items only after retrieval**.

ğŸ“Œ **Expensive!** Consider using **GSIs (Global Secondary Indexes)** instead of scanning.

---

## ğŸ”¹ **Optimizing Read Costs: Alternatives to `FilterExpression`**

Instead of using `FilterExpression`, **optimize queries using the following:**

| **Optimization**                                               | **Method**                                     | **Effect on RCU Costs**                      |
| -------------------------------------------------------------- | ---------------------------------------------- | -------------------------------------------- |
| **Use `KeyConditionExpression` instead of `FilterExpression`** | Query based on **Partition Key + Sort Key**    | âœ… **Lowers RCUs by retrieving fewer items** |
| **Use Global Secondary Indexes (GSIs)**                        | Create an index on non-key attributes          | âœ… **Retrieves fewer items, reducing RCUs**  |
| **Use `ProjectionExpression`**                                 | Retrieve only needed attributes                | âœ… **Reduces data transfer costs**           |
| **Use `Limit` parameter**                                      | Restrict the number of items returned per call | âœ… **Prevents excessive reads per request**  |

---

## ğŸ”¥ **FilterExpression vs. GSI: Which One is Better?**

ğŸ“Œ **Using `FilterExpression` (Bad for Performance)**

```sh
aws dynamodb query \
    --table-name Orders \
    --key-condition-expression "CustomerID = :cust" \
    --filter-expression "Status = :status" \
    --expression-attribute-values '{
        ":cust": {"S": "User123"},
        ":status": {"S": "Completed"}
    }'
```

ğŸ”´ **Issues:**

- Reads **all orders** for `User123` before filtering.
- **Consumes RCUs for all retrieved items** (even if most are filtered out).

ğŸ“Œ **Using GSI Instead (Better Performance)**

```sh
aws dynamodb query \
    --table-name Orders \
    --index-name StatusIndex \
    --key-condition-expression "Status = :status" \
    --expression-attribute-values '{":status": {"S": "Completed"}}'
```

âœ… **Advantages of GSI:**

- Queries **only "Completed" orders**, reducing RCUs.
- More efficient than scanning and filtering after retrieval.

---

## ğŸ† **Key Takeaways**

âœ” **`FilterExpression` does not reduce RCU consumption because it is applied after retrieving items.**  
âœ” **For optimal performance, always use `KeyConditionExpression` instead of `FilterExpression` where possible.**  
âœ” **Scans are costly; avoid using `FilterExpression` with `Scan` unless necessary.**  
âœ” **Use GSIs to query non-key attributes efficiently.**  
âœ” **Use `ProjectionExpression` to retrieve only required attributes, reducing data transfer costs.**

By **avoiding unnecessary filters and using indexes**, you can **reduce read costs and improve query performance** in DynamoDB! ğŸš€
